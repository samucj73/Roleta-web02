<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Previsor de Roleta - Padrões e Análise Avançada</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
    h1 { color: #333; }
    input[type="file"] { margin-top: 10px; }
    #output, #resultados, #padroes { margin-top: 20px; }
    canvas { margin-top: 20px; }
    img { max-width: 100%; margin-top: 10px; }
    .loading { color: green; font-weight: bold; }
    ul { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Previsor de Números da Roleta</h1>
  <p>Envie uma imagem com números (JPEG):</p>
  <input type="file" accept="image/*" onchange="handleFile(this)">
  <div id="output"></div>
  <div id="resultados"></div>
  <div id="padroes"></div>
  <canvas id="graficoFrequencia"></canvas>
  <canvas id="graficoParImpar"></canvas>
  <canvas id="graficoZonas"></canvas>

  <script>
    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        document.getElementById("output").innerHTML = '<p class="loading">Lendo imagem e extraindo números...</p>';
        document.getElementById("output").appendChild(img);

        Tesseract.recognize(
          e.target.result,
          'eng',
          { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
          const numeros = Array.from(text.matchAll(/\d+/g)).map(n => parseInt(n[0]))
            .filter(n => n >= 0 && n <= 36);

          document.getElementById("output").innerHTML =
            "<p><strong>Números extraídos:</strong><br>" + numeros.join(", ") + "</p>";

          mostrarAnalise(numeros);
        });
      };
      reader.readAsDataURL(file);
    }

    function mostrarAnalise(numeros) {
      if (numeros.length === 0) {
        document.getElementById("resultados").innerHTML = "<p>Nenhum número válido foi identificado.</p>";
        return;
      }

      const contagem = {};
      const zonas = [0, 0, 0];
      let pares = 0, impares = 0;

      numeros.forEach(n => {
        contagem[n] = (contagem[n] || 0) + 1;
        if (n >= 1 && n <= 12) zonas[0]++;
        else if (n >= 13 && n <= 24) zonas[1]++;
        else if (n >= 25 && n <= 36) zonas[2]++;
        if (n !== 0) (n % 2 === 0 ? pares++ : impares++);
      });

      const top10 = Object.entries(contagem).sort((a, b) => b[1] - a[1]).slice(0, 10).map(e => e[0]);

      document.getElementById("resultados").innerHTML = `
        <h3>Top 10 Números Prováveis:</h3>
        <p>${top10.join(", ")}</p>
        <p><strong>Quantidade total de números analisados:</strong> ${numeros.length}</p>
      `;

      // Padrões
      let padroesHtml = "<h3>Padrões Numéricos Detectados:</h3><ul>";

      const repeticoes = Object.entries(contagem).filter(([n, c]) => c >= 3);
      if (repeticoes.length) {
        padroesHtml += "<li><strong>Repetições:</strong> " + repeticoes.map(([n]) => n).join(", ") + "</li>";
      }

      const saltos = [];
      for (let i = 1; i < numeros.length - 1; i++) {
        const diff1 = numeros[i] - numeros[i - 1];
        const diff2 = numeros[i + 1] - numeros[i];
        if (diff1 === diff2 && Math.abs(diff1) <= 12) {
          saltos.push(`Sequência: ${numeros[i - 1]}, ${numeros[i]}, ${numeros[i + 1]} (salto de ${diff1})`);
        }
      }
      if (saltos.length) {
        padroesHtml += "<li><strong>Saltos Fixos:</strong><br>" + saltos.join("<br>") + "</li>";
      }

      const medias = [];
      for (let i = 0; i < numeros.length - 4; i++) {
        const grupo = numeros.slice(i, i + 5);
        const media = grupo.reduce((a, b) => a + b, 0) / 5;
        medias.push(media.toFixed(2));
      }
      padroesHtml += "<li><strong>Médias móveis (a cada 5 números):</strong> " + medias.join(", ") + "</li>";

      const finais = {};
      numeros.forEach(n => {
        const fim = n % 10;
        finais[fim] = (finais[fim] || 0) + 1;
      });
      const topFinais = Object.entries(finais).sort((a, b) => b[1] - a[1]).slice(0, 3);
      padroesHtml += "<li><strong>Terminações mais comuns:</strong> " + topFinais.map(e => e[0]).join(", ") + "</li>";

      padroesHtml += "</ul>";
      document.getElementById("padroes").innerHTML = padroesHtml;

      // Gráficos
      const labels = Array.from({ length: 37 }, (_, i) => i);
      const dataFreq = labels.map(n => contagem[n] || 0);

      new Chart(document.getElementById("graficoFrequencia"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Frequência de Números",
            data: dataFreq,
            backgroundColor: "rgba(0, 123, 255, 0.6)"
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      new Chart(document.getElementById("graficoParImpar"), {
        type: "pie",
        data: {
          labels: ["Pares", "Ímpares"],
          datasets: [{
            data: [pares, impares],
            backgroundColor: ["#28a745", "#dc3545"]
          }]
        }
      });

      new Chart(document.getElementById("graficoZonas"), {
        type: "bar",
        data: {
          labels: ["Zona 1 (1-12)", "Zona 2 (13-24)", "Zona 3 (25-36)"],
          datasets: [{
            label: "Distribuição por Zona",
            data: zonas,
            backgroundColor: ["#ffc107", "#17a2b8", "#6f42c1"]
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
