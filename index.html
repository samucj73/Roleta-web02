<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Previsor de Roleta com IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 960px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #007bff; }
    input[type="file"] { display: block; margin: 20px auto; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; }
    button { display: block; margin: 20px auto; padding: 12px 24px; font-size: 16px; background: #007bff; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #0056b3; }
    canvas { margin-top: 20px; }
    .section { margin-top: 30px; }
    .loading { text-align: center; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container" id="relatorio">
    <h1>Previsor de Números da Roleta com IA</h1>
    <input type="file" accept="image/*" onchange="handleFile(this)">
    <div id="output" class="section"></div>
    <div id="analises" class="section"></div>
    <div class="section">
      <canvas id="graficoFrequencia"></canvas>
      <canvas id="graficoParImpar"></canvas>
      <canvas id="graficoZonas"></canvas>
    </div>
    <div class="section" id="padroes"></div>
    <div class="section" id="ia-previsao"></div>
  </div>
  <button onclick="gerarPDF()">Baixar PDF com os Resultados</button>

  <script>
    let numerosExtraidos = [];

    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.createElement("img");
        img.src = e.target.result;
        document.getElementById("output").innerHTML = '<p class="loading">Lendo imagem...</p>';
        document.getElementById("output").appendChild(img);

        Tesseract.recognize(e.target.result, 'eng', { logger: m => console.log(m) })
          .then(({ data: { text } }) => {
            const numeros = Array.from(text.matchAll(/\d+/g)).map(n => parseInt(n[0])).filter(n => n >= 0 && n <= 36);
            numerosExtraidos = numeros;
            document.getElementById("output").innerHTML += `<p><strong>Números extraídos:</strong> ${numeros.join(", ")}</p>`;
            analisarNumeros(numeros);
            rodarIA(numeros);
          });
      };
      reader.readAsDataURL(file);
    }

    function analisarNumeros(numeros) {
      const contagem = {};
      const zonas = [0, 0, 0];
      let pares = 0, impares = 0;

      numeros.forEach(n => {
        contagem[n] = (contagem[n] || 0) + 1;
        if (n >= 1 && n <= 12) zonas[0]++;
        else if (n >= 13 && n <= 24) zonas[1]++;
        else if (n >= 25 && n <= 36) zonas[2]++;
        if (n !== 0) (n % 2 === 0 ? pares++ : impares++);
      });

      const top10 = Object.entries(contagem).sort((a, b) => b[1] - a[1]).slice(-10).reverse().map(e => e[0]);
      document.getElementById("analises").innerHTML = `<h3>Top 10 Números Frequentes:</h3><p>${top10.join(", ")}</p>`;

      // Padrões
      let padroesHtml = "<h3>Padrões Numéricos:</h3><ul>";

      const repeticoes = Object.entries(contagem).filter(([_, c]) => c >= 3);
      if (repeticoes.length) padroesHtml += `<li><strong>Repetições:</strong> ${repeticoes.map(([n]) => n).join(", ")}</li>`;

      const saltos = [];
      for (let i = 1; i < numeros.length - 1; i++) {
        const d1 = numeros[i] - numeros[i - 1];
        const d2 = numeros[i + 1] - numeros[i];
        if (d1 === d2) saltos.push(`${numeros[i - 1]}, ${numeros[i]}, ${numeros[i + 1]}`);
      }
      if (saltos.length) padroesHtml += `<li><strong>Saltos Fixos:</strong> ${saltos.join(" | ")}</li>`;

      const finais = {};
      numeros.forEach(n => {
        const f = n % 10;
        finais[f] = (finais[f] || 0) + 1;
      });
      const topFinais = Object.entries(finais).sort((a, b) => b[1] - a[1]).slice(0, 3);
      padroesHtml += `<li><strong>Terminações Mais Frequentes:</strong> ${topFinais.map(([n]) => n).join(", ")}</li>`;

      padroesHtml += "</ul>";
      document.getElementById("padroes").innerHTML = padroesHtml;

      // Gráficos
      const labels = Array.from({ length: 37 }, (_, i) => i);
      const dataFreq = labels.map(n => contagem[n] || 0);

      new Chart(document.getElementById("graficoFrequencia"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Frequência de Números",
            data: dataFreq,
            backgroundColor: "rgba(0, 123, 255, 0.6)"
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      new Chart(document.getElementById("graficoParImpar"), {
        type: "pie",
        data: {
          labels: ["Pares", "Ímpares"],
          datasets: [{
            data: [pares, impares],
            backgroundColor: ["#28a745", "#dc3545"]
          }]
        }
      });

      new Chart(document.getElementById("graficoZonas"), {
        type: "bar",
        data: {
          labels: ["Zona 1 (1-12)", "Zona 2 (13-24)", "Zona 3 (25-36)"],
          datasets: [{
            label: "Distribuição por Zona",
            data: zonas,
            backgroundColor: ["#ffc107", "#17a2b8", "#6f42c1"]
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    async function rodarIA(numeros) {
      if (numeros.length < 10) {
        document.getElementById("ia-previsao").innerHTML = "<p>IA: Dados insuficientes para prever próximos números.</p>";
        return;
      }

      // Preparar dados
      const xs = [], ys = [];
      for (let i = 0; i < numeros.length - 3; i++) {
        xs.push([numeros[i], numeros[i+1], numeros[i+2]]);
        ys.push(numeros[i+3]);
      }

      const model = tf.sequential();
      model.add(tf.layers.dense({ units: 16, inputShape: [3], activation: "relu" }));
      model.add(tf.layers.dense({ units: 16, activation: "relu" }));
      model.add(tf.layers.dense({ units: 1 }));

      model.compile({ optimizer: "adam", loss: "meanSquaredError" });

      const xsTensor = tf.tensor2d(xs);
      const ysTensor = tf.tensor2d(ys, [ys.length, 1]);

      await model.fit(xsTensor, ysTensor, { epochs: 50, verbose: 0 });

      const previsoes = [];
      let entrada = numeros.slice(-3);
      for (let i = 0; i < 10; i++) {
        const pred = model.predict(tf.tensor2d([entrada])).dataSync()[0];
        const proximo = Math.round(Math.max(0, Math.min(36, pred)));
        previsoes.push(proximo);
        entrada = [entrada[1], entrada[2], proximo];
      }

      document.getElementById("ia-previsao").innerHTML = `<h3>Previsões com IA (TensorFlow.js):</h3><p>${previsoes.join(", ")}</p>`;
    }

    function gerarPDF() {
      const elemento = document.getElementById("relatorio");
      html2pdf().from(elemento).save("relatorio-roleta.pdf");
    }
  </script>
</body>
</html>
