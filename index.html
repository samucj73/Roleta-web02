<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Previsor de Roleta - 100% Web</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    input[type="file"] {
      display: block;
      margin: 20px auto;
    }
    button {
      display: inline-block;
      margin: 10px;
      padding: 10px 20px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    #resultados, #previsoesIA {
      margin-top: 20px;
      white-space: pre-line;
    }
    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Previsor de Números da Roleta</h1>
    <input type="file" accept="image/*" onchange="handleFile(this)">
    <div id="resultados"></div>
    <div id="previsoesIA"></div>
    <canvas id="graficoFrequencia" width="700" height="300"></canvas>
    <button onclick="gerarPDF()">Gerar PDF</button>
    <button onclick="resetar()">Resetar Análises</button>
  </div>

  <script>
    let numerosExtraidos = [];

    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        Tesseract.recognize(e.target.result, 'eng', {
          logger: m => console.log(m)
        }).then(({ data: { text } }) => {
          const numeros = Array.from(text.matchAll(/\d+/g)).map(n => parseInt(n[0]));
          numerosExtraidos = numeros;
          realizarAnalises(numeros);
        });
      };
      reader.readAsDataURL(file);
    }

    function realizarAnalises(numeros) {
      const contagem = {};
      numeros.forEach(n => contagem[n] = (contagem[n] || 0) + 1);

      const total = numeros.length;
      const media = (numeros.reduce((a, b) => a + b, 0) / total).toFixed(2);
      const moda = Object.entries(contagem).reduce((a, b) => (a[1] > b[1] ? a : b))[0];
      const mediana = (() => {
        const sorted = [...numeros].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 ? sorted[mid] : ((sorted[mid - 1] + sorted[mid]) / 2).toFixed(2);
      })();
      const desvio = (() => {
        const m = parseFloat(media);
        const variancia = numeros.reduce((a, b) => a + Math.pow(b - m, 2), 0) / total;
        return Math.sqrt(variancia).toFixed(2);
      })();
      const pares = numeros.filter(n => n % 2 === 0).length;
      const impares = total - pares;

      const analise = `
Total de números: ${total}
Média: ${media}
Mediana: ${mediana}
Moda: ${moda}
Desvio padrão: ${desvio}
Pares: ${pares}
Ímpares: ${impares}
`;

      document.getElementById("resultados").innerText = analise;
      mostrarPrevisoesIA(contagem);
      plotarGrafico(contagem);
    }

    function mostrarPrevisoesIA(contagem) {
      const top = Object.entries(contagem)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(e => e[0]);

      document.getElementById("previsoesIA").innerText = "Top 10 números previstos (IA simples):\n" + top.join(", ");
    }

    function plotarGrafico(contagem) {
      const ctx = document.getElementById("graficoFrequencia").getContext("2d");
      if (window.grafico) window.grafico.destroy();
      window.grafico = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(contagem),
          datasets: [{
            label: 'Frequência',
            data: Object.values(contagem),
            backgroundColor: '#3498db'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }

    function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "mm", "a4");
      let y = 10;

      doc.setFontSize(16);
      doc.text("Relatório de Análise da Roleta", 20, y);
      y += 10;

      doc.setFontSize(12);
      const resultados = document.getElementById("resultados").innerText;
      resultados.split("\n").forEach(linha => {
        doc.text(linha, 20, y);
        y += 7;
      });

      const previsoes = document.getElementById("previsoesIA").innerText;
      previsoes.split("\n").forEach(linha => {
        doc.text(linha, 20, y);
        y += 7;
      });

      const canvas = document.getElementById("graficoFrequencia");
      const imgData = canvas.toDataURL("image/png", 1.0);
      if (y + 110 > 280) y = 180;
      doc.setFontSize(14);
      doc.text("Gráfico de Frequência dos Números", 20, y + 10);
      doc.addImage(imgData, "PNG", 15, y + 15, 180, 100);

      doc.save("analise_roleta.pdf");
    }

    function resetar() {
      numerosExtraidos = [];
      document.getElementById("resultados").innerText = "";
      document.getElementById("previsoesIA").innerText = "";
      if (window.grafico) window.grafico.destroy();
    }
  </script>
</body>
</html>
